<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planeador de Atividades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Bibliotecas para Exportação PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Altura de cada slot de hora */
        :root {
            --hour-height: 80px;
        }
        
        .hour-slot {
            height: var(--hour-height);
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Classe utilitária para esconder elementos durante a geração do PDF se necessário */
        .hide-on-print {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans overflow-hidden">

    <!-- Cabeçalho Principal (Fixo no topo da app) -->
    <header id="app-header" class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm flex justify-between items-center z-50 relative">
        <div class="flex items-center gap-3">
            <i class="fas fa-calendar-alt text-blue-600 text-2xl"></i>
            <h1 class="text-xl font-bold text-gray-800 hidden md:block">Planejador de viagem</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Display do Total de Gastos -->
            <div class="bg-green-50 text-green-800 px-3 py-2 rounded-lg text-sm font-bold border border-green-200 flex items-center gap-2 shadow-sm">
                <i class="fas fa-coins text-green-600"></i>
                <span>Total: <span id="total-display">€ 0.00</span></span>
            </div>

            <!-- Botão Exportar PDF -->
            <button onclick="exportToPDF()" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm" id="btn-export">
                <i class="fas fa-file-pdf"></i>
                <span class="hidden sm:inline">Exportar PDF</span>
            </button>
        </div>
    </header>

    <!-- Contentor Principal do Planeador -->
    <main class="flex-1 overflow-auto relative flex" id="scheduler-container">
        
        <!-- Coluna de Horas (Lateral Esquerda) -->
        <!-- z-40 para garantir que fica acima das colunas normais mas abaixo do modal -->
        <div class="w-16 flex-shrink-0 bg-white border-r border-gray-200 sticky left-0 z-40 shadow-md flex flex-col" id="time-column">
            <!-- Canto Superior Esquerdo "HORA" (Sticky total: topo e esquerda) -->
            <div class="h-16 border-b border-gray-200 bg-gray-50 flex items-center justify-center font-bold text-gray-400 text-xs sticky top-0 z-50 shadow-sm">
                HORA
            </div>
            <!-- As horas serão geradas via JS aqui -->
            <div id="time-labels-container" class="relative pt-4 flex-1"></div> 
        </div>

        <!-- Grelha de Atividades (7 Colunas) -->
        <div class="flex-1 min-w-[800px] grid grid-cols-7 divide-x divide-gray-200 bg-white" id="grid-columns">
            <!-- As 7 colunas serão geradas via JS -->
        </div>

    </main>

    <!-- Modal (Pop-up) de Adicionar Atividade -->
    <div id="activityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all scale-100 overflow-hidden flex flex-col max-h-[90vh]">
            
            <!-- Cabeçalho do Modal -->
            <div class="bg-blue-600 px-6 py-4 flex justify-between items-center shrink-0">
                <h2 class="text-white font-bold text-lg">Nova Atividade</h2>
                <button onclick="closeModal()" class="text-white hover:text-blue-200 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Formulário Scrollável -->
            <form id="activityForm" onsubmit="saveActivity(event)" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="targetColumnIndex">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Atividade</label>
                    <input type="text" id="actName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Ex: Aula de Yoga">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Preço Estimado (R$)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">R$</span>
                        <input type="number" step="0.01" id="actPrice" required class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Início</label>
                        <select id="actStart" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                            <!-- Opções geradas via JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fim</label>
                        <select id="actEnd" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                            <!-- Opções geradas via JS -->
                        </select>
                    </div>
                </div>

                <!-- Secção da Foto com Paste Listener -->
                <div class="relative group">
                    <label class="block text-sm font-medium text-gray-700 mb-1 flex justify-between">
                        <span>Foto</span>
                        <span class="text-xs text-blue-500 font-normal animate-pulse">Pode colar imagem (Ctrl+V)</span>
                    </label>
                    
                    <div class="relative">
                        <input type="text" id="actPhoto" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition pr-8" placeholder="URL ou Ctrl+V para colar">
                        <i class="fas fa-image absolute right-3 top-3 text-gray-400"></i>
                    </div>

                    <!-- Preview de imagem colada -->
                    <div id="pastePreviewContainer" class="hidden mt-2 p-2 bg-gray-50 border border-dashed border-gray-300 rounded-lg text-center">
                        <p class="text-xs text-green-600 mb-1 font-bold"><i class="fas fa-check-circle"></i> Imagem pronta para usar</p>
                        <img id="pastePreview" src="" class="h-20 mx-auto rounded object-cover shadow-sm">
                        <button type="button" onclick="clearPastedImage()" class="text-xs text-red-500 underline mt-1 hover:text-red-700">Remover</button>
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition transform hover:-translate-y-0.5">
                        Adicionar à Agenda
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Indicador de Loading para Exportação -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[70] flex items-center justify-center flex-col">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
        <p class="text-white font-bold text-lg">A gerar PDF...</p>
    </div>

    <script>
        // Configuração
        const startHour = 6;
        const endHour = 23;
        const numColumns = 7;
        const hourHeight = 80;
        const defaultImage = "https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?auto=format&fit=crop&q=80&w=400";

        document.addEventListener('DOMContentLoaded', () => {
            initGrid();
            populateTimeSelects();
            setupPasteListener();
            updateTotal(); 
        });

        function initGrid() {
            const timeLabelsContainer = document.getElementById('time-labels-container');
            const gridColumnsContainer = document.getElementById('grid-columns');

            // 1. Gerar etiquetas de tempo
            for (let h = startHour; h <= endHour; h++) {
                const hourDiv = document.createElement('div');
                hourDiv.className = 'hour-slot w-full relative'; 
                
                // Texto da hora
                const timeText = document.createElement('span');
                timeText.className = 'absolute -top-3 left-0 w-full text-center text-xs text-gray-500 font-bold bg-white px-1 z-10';
                timeText.innerText = `${h.toString().padStart(2, '0')}:00`;

                // Linha visual
                const line = document.createElement('div');
                line.className = 'absolute top-0 w-full border-t border-gray-200 right-0';
                line.style.width = '1000%'; 
                
                hourDiv.appendChild(line);
                hourDiv.appendChild(timeText);
                timeLabelsContainer.appendChild(hourDiv);
            }

            // 2. Gerar as 7 colunas (Dias)
            for (let i = 0; i < numColumns; i++) {
                const col = document.createElement('div');
                col.className = 'relative flex flex-col h-full group bg-white';
                col.id = `col-${i}`;

                const header = document.createElement('div');
                // Adicionado z-30 para ficar acima dos cartões (z-10) ao fazer scroll
                // sticky top-0 garante que fica fixo no topo da janela de visualização do main
                header.className = 'h-16 border-b border-gray-200 bg-gray-50 flex items-center justify-between px-3 sticky top-0 z-30 shadow-sm col-header';
                header.innerHTML = `
                    <span class="font-bold text-gray-700">Dia ${i + 1}</span>
                    <button onclick="openModal(${i})" class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-600 hover:text-white flex items-center justify-center transition shadow-sm add-btn" title="Adicionar Atividade">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                col.appendChild(header);

                const body = document.createElement('div');
                body.className = 'relative flex-1 w-full';
                body.style.height = `${(endHour - startHour + 1) * hourHeight}px`;

                // Linhas de fundo
                for (let h = startHour; h <= endHour; h++) {
                    const line = document.createElement('div');
                    line.className = 'border-b border-gray-100 w-full absolute pointer-events-none';
                    line.style.height = `${hourHeight}px`;
                    line.style.top = `${(h - startHour) * hourHeight}px`;
                    body.appendChild(line);
                }

                col.appendChild(body);
                gridColumnsContainer.appendChild(col);
            }
        }

        function populateTimeSelects() {
            const startSelect = document.getElementById('actStart');
            const endSelect = document.getElementById('actEnd');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';

            for (let h = startHour; h <= endHour; h++) {
                ['00', '30'].forEach(min => {
                    const timeString = `${h.toString().padStart(2, '0')}:${min}`;
                    const val = h + (min === '30' ? 0.5 : 0);
                    
                    const optS = document.createElement('option');
                    optS.value = val;
                    optS.text = timeString;
                    startSelect.appendChild(optS);

                    const optE = document.createElement('option');
                    optE.value = val;
                    optE.text = timeString;
                    endSelect.appendChild(optE);
                });
            }
            const optFinal = document.createElement('option');
            optFinal.value = endHour + 1; 
            optFinal.text = `${(endHour+1).toString().padStart(2, '0')}:00`;
            endSelect.appendChild(optFinal);
        }

        // --- Lógica do Modal e Paste ---

        function openModal(colIndex) {
            document.getElementById('targetColumnIndex').value = colIndex;
            document.getElementById('activityForm').reset();
            clearPastedImage();
            
            const now = new Date();
            let currentHour = now.getHours();
            if(currentHour < startHour) currentHour = startHour;
            if(currentHour > endHour) currentHour = startHour;
            
            document.getElementById('actStart').value = currentHour;
            document.getElementById('actEnd').value = currentHour + 1;

            document.getElementById('activityModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('activityModal').classList.add('hidden');
        }

        function setupPasteListener() {
            document.addEventListener('paste', (event) => {
                const modal = document.getElementById('activityModal');
                if (modal.classList.contains('hidden')) return;

                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        
                        reader.onload = (e) => {
                            const base64Image = e.target.result;
                            document.getElementById('actPhoto').value = base64Image;
                            const previewContainer = document.getElementById('pastePreviewContainer');
                            const previewImg = document.getElementById('pastePreview');
                            previewImg.src = base64Image;
                            previewContainer.classList.remove('hidden');
                        };
                        
                        reader.readAsDataURL(blob);
                        event.preventDefault();
                    }
                }
            });

            document.getElementById('actPhoto').addEventListener('input', function() {
                if (this.value === '') clearPastedImage();
            });
        }

        function clearPastedImage() {
            document.getElementById('pastePreviewContainer').classList.add('hidden');
            document.getElementById('pastePreview').src = '';
        }

        document.getElementById('activityModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('activityModal')) {
                closeModal();
            }
        });

        // --- Salvar, Renderizar e Total ---

        function saveActivity(e) {
            e.preventDefault();

            const colIndex = parseInt(document.getElementById('targetColumnIndex').value);
            const name = document.getElementById('actName').value;
            const price = parseFloat(document.getElementById('actPrice').value).toFixed(2);
            const startVal = parseFloat(document.getElementById('actStart').value);
            const endVal = parseFloat(document.getElementById('actEnd').value);
            let photo = document.getElementById('actPhoto').value;

            if (startVal >= endVal) {
                alert("A hora de fim deve ser posterior à hora de início.");
                return;
            }

            if (!photo || photo.trim() === '') {
                photo = defaultImage;
            }

            createActivityElement(colIndex, name, price, startVal, endVal, photo);
            closeModal();
        }

        function createActivityElement(colIndex, name, price, startVal, endVal, photo) {
            const columnBody = document.querySelector(`#col-${colIndex} > div:nth-child(2)`);
            const topPosition = (startVal - startHour) * hourHeight;
            const duration = endVal - startVal;
            const height = duration * hourHeight;

            const formatTime = (val) => {
                const h = Math.floor(val);
                const m = (val - h) * 60;
                return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
            };

            const card = document.createElement('div');
            // z-10 para cartões, para que os headers (z-30) passem por cima
            card.className = 'absolute left-1 right-1 bg-blue-50 border-l-4 border-blue-500 rounded shadow-sm hover:shadow-md transition-shadow cursor-pointer overflow-hidden flex flex-col p-2 group z-10 act-card';
            card.style.top = `${topPosition}px`;
            card.style.height = `${height - 2}px`; 
            card.style.transition = 'all 0.3s ease';
            
            card.dataset.price = price;
            // Guardar duração para uso na exportação PDF
            card.dataset.duration = duration;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-1 shrink-0">
                    <div class="overflow-hidden w-full">
                        <h3 class="font-bold text-gray-800 text-sm leading-tight truncate" title="${name}">${name}</h3>
                        <p class="text-xs font-bold text-green-600">€ ${price}</p>
                    </div>
                    <button onclick="deleteActivity(this)" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity delete-btn ml-1" data-html2canvas-ignore="true">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                </div>
                
                <div class="text-[10px] text-gray-500 mb-1 flex items-center gap-1 shrink-0">
                    <i class="far fa-clock"></i> ${formatTime(startVal)} - ${formatTime(endVal)}
                </div>

                <div class="flex-1 w-full relative rounded overflow-hidden mt-1 min-h-[10px] bg-gray-200 act-image-container">
                    <img src="${photo}" alt="${name}" class="absolute inset-0 w-full h-full object-cover" onerror="this.src='${defaultImage}'">
                </div>
            `;

            columnBody.appendChild(card);
            updateTotal(); 
        }

        function deleteActivity(btn) {
            const card = btn.closest('.act-card');
            if (card) {
                card.remove();
                updateTotal(); 
            }
        }

        function updateTotal() {
            const cards = document.querySelectorAll('.act-card');
            let total = 0;
            
            cards.forEach(card => {
                const price = parseFloat(card.dataset.price) || 0;
                total += price;
            });

            document.getElementById('total-display').innerText = `R$ ${total.toFixed(2)}`;
        }

        // --- Exportação PDF ---

        window.jsPDF = window.jspdf.jsPDF;

        async function exportToPDF() {
            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden');

            try {
                // 1. Clonar os elementos relevantes
                const tempContainer = document.createElement('div');
                tempContainer.className = 'bg-white p-4 font-sans';
                tempContainer.style.position = 'absolute';
                tempContainer.style.top = '-9999px';
                tempContainer.style.left = '0';
                tempContainer.style.width = '1600px'; 
                tempContainer.style.zIndex = '-1';

                // Copiar Cabeçalho
                const headerClone = document.getElementById('app-header').cloneNode(true);
                headerClone.querySelector('#btn-export').remove(); 
                headerClone.classList.remove('sticky', 'shadow-sm', 'border-b', 'fixed', 'top-0', 'left-0', 'right-0', 'z-50');
                headerClone.classList.add('mb-4', 'border-b-2', 'border-gray-800');
                
                // Copiar o container principal
                const mainClone = document.getElementById('scheduler-container').cloneNode(true);
                mainClone.style.overflow = 'visible';
                mainClone.style.height = 'auto';
                mainClone.classList.remove('flex-1', 'overflow-auto', 'relative');
                
                // Limpar estilos sticky e overflow dentro do clone
                const timeCol = mainClone.querySelector('#time-column');
                timeCol.classList.remove('sticky', 'h-screen', 'left-0', 'z-40');
                timeCol.style.height = 'auto';
                
                // Remover sticky da célula "HORA" no clone
                const timeHeader = timeCol.querySelector('div:first-child');
                if(timeHeader) timeHeader.classList.remove('sticky', 'top-0', 'z-50');

                const gridCols = mainClone.querySelector('#grid-columns');
                gridCols.classList.remove('min-w-[800px]');
                
                mainClone.querySelectorAll('.col-header').forEach(el => {
                    el.classList.remove('sticky', 'top-0', 'z-30');
                    const btn = el.querySelector('.add-btn');
                    if(btn) btn.remove();
                });

                // Remover botões de deletar
                mainClone.querySelectorAll('.delete-btn').forEach(btn => btn.remove());

                // --- Lógica de Priorização de PDF ---
                // Percorrer todas as atividades no clone para otimizar visualização
                mainClone.querySelectorAll('.act-card').forEach(card => {
                    const duration = parseFloat(card.dataset.duration);
                    
                    // Priorização: Se a duração for pequena (<= 1h), esconder imagem para garantir texto visível
                    // Também forçamos a cor do texto para preto puro para melhor contraste
                    const imgContainer = card.querySelector('.act-image-container');
                    const title = card.querySelector('h3');
                    const price = card.querySelector('p.text-green-600');

                    if (title) {
                        title.classList.remove('truncate'); // Permitir quebra de linha se necessário
                        title.style.whiteSpace = 'normal';
                    }

                    if (duration <= 1.0) { // Se 1 hora ou menos
                        if (imgContainer) {
                            imgContainer.style.display = 'none'; // Ocultar imagem
                        }
                        // Ajustar o cartão para auto-height ou garantir que o texto cabe
                        card.style.display = 'flex';
                        card.style.flexDirection = 'column';
                        card.style.justifyContent = 'center';
                    }
                });

                tempContainer.appendChild(headerClone);
                tempContainer.appendChild(mainClone);
                document.body.appendChild(tempContainer);

                // 2. Gerar Canvas
                const canvas = await html2canvas(tempContainer, {
                    scale: 3, 
                    useCORS: true, 
                    logging: false,
                    windowWidth: 1600
                });

                // 3. Gerar PDF
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);

                const finalWidth = imgWidth * ratio;
                const finalHeight = imgHeight * ratio;

                const x = (pdfWidth - finalWidth) / 2;
                const y = (pdfHeight - finalHeight) / 2;

                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                
                pdf.addImage(imgData, 'JPEG', x, y, finalWidth, finalHeight);
                pdf.save('planeador-semanal.pdf');

                document.body.removeChild(tempContainer);

            } catch (err) {
                console.error("Erro ao gerar PDF:", err);
                alert("Ocorreu um erro ao gerar o PDF. Verifique a consola.");
            } finally {
                loading.classList.add('hidden');
            }
        }
    </script>
</body>
</html>