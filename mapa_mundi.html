<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive World Map</title>
    <!-- Tailwind CSS for layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js and TopoJSON -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <style>
        /* Map Specific Styles */
        body {
            background-color: #f1f4ee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #map-container {
            width: 100%;
            height: 70vh;
            background-color: #f1f4ee;
            overflow: hidden;
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }

        svg {
            display: block;
            margin: auto;
        }

        /* The Country Paths */
        .country {
            fill: #f1f4ee;      /* White background */
            stroke: #000000;    /* Black outline */
            stroke-width: 0.5px;
            cursor: pointer;
            transition: fill 0.2s ease;
        }

        /* Hover State */
        .country:hover {
            fill: #e0e0e0;
        }

        /* Selected States */
        .country.green {
            fill: #90EE90 !important; /* Light green */
        }
        
        .country.red {
            fill: #FF9999 !important; /* Light red */
        }

        /* Tooltip */
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        /* Loading Overlay */
        #loading {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            font-weight: bold;
            color: #333;
            gap: 1rem;
        }
        
        .retry-btn {
            padding: 8px 16px;
            background-color: #3b82f6;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }
        .retry-btn:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto">

    <div class="mb-6 space-y-4">
        <h1 class="text-3xl font-bold text-gray-800">World Map Selector</h1>
        
        <!-- Color Selection Controls -->
        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center bg-gray-50 p-4 rounded-lg border">
            <span class="font-bold text-gray-700">1. Select Color:</span>
            <div class="flex gap-2">
                <button id="btn-green" onclick="setMode('green')" class="px-4 py-2 bg-green-200 border-2 border-green-600 text-green-900 rounded font-bold shadow-sm transition">
                    Green Mode
                </button>
                <button id="btn-red" onclick="setMode('red')" class="px-4 py-2 bg-red-100 border-2 border-transparent hover:bg-red-200 text-red-900 rounded transition">
                    Red Mode
                </button>
            </div>
            <span class="text-sm text-gray-500 italic ml-2">Current click will paint countries this color.</span>
        </div>

        <p class="text-gray-600">2. Click countries on the map or use the continent buttons below.</p>
        
        <!-- Continent Controls -->
        <div class="flex flex-wrap gap-2" id="controls">
            <button onclick="selectContinent('Americas')" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded transition text-sm">Americas</button>
            <button onclick="selectContinent('Europe')" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded transition text-sm">Europe</button>
            <button onclick="selectContinent('Africa')" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded transition text-sm">Africa</button>
            <button onclick="selectContinent('Asia')" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded transition text-sm">Asia</button>
            <button onclick="selectContinent('Oceania')" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded transition text-sm">Oceania</button>
            <div class="w-px h-6 bg-gray-300 mx-1"></div>
            <button onclick="resetMap()" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded transition text-sm">Clear Map</button>
        </div>
    </div>

    <!-- Map Visualization -->
    <div id="map-container" class="shadow-lg">
        <div id="loading">
            <span>Loading Map Data...</span>
        </div>
        <div id="tooltip"></div>
    </div>
    
    <div class="mt-4 flex gap-8 justify-center text-sm text-gray-600">
        <div>Green Count: <span id="count-green" class="font-bold text-green-600 text-lg">0</span></div>
        <div>Red Count: <span id="count-red" class="font-bold text-red-600 text-lg">0</span></div>
    </div>

    <script>
        // Configuration
        const width = 960;
        const height = 500;
        let countriesData = [];
        let metadata = {}; 
        let currentMode = 'green'; // Default mode

        // Select DOM elements
        const svg = d3.select("#map-container")
            .append("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet")
            .style("width", "100%")
            .style("height", "100%");

        const tooltip = d3.select("#tooltip");
        const countGreenSpan = document.getElementById("count-green");
        const countRedSpan = document.getElementById("count-red");
        const loadingDiv = document.getElementById("loading");

        const btnGreen = document.getElementById("btn-green");
        const btnRed = document.getElementById("btn-red");

        // Map Projection
        const projection = d3.geoMercator()
            .scale(140)
            .translate([width / 2, height / 1.4]);

        const path = d3.geoPath().projection(projection);

        const g = svg.append("g");

        // Zoom Behavior
        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // --- Data Fetching ---
        function loadData() {
            loadingDiv.innerHTML = '<span>Loading Map Data...</span>';
            loadingDiv.style.display = 'flex';

            // Use jsdelivr for both to ensure better caching and avoid GitHub raw rate limits (429)
            const topologyUrl = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";
            // Switched to jsdelivr CDN for the GitHub file to avoid raw.githubusercontent 429 errors
            const metadataUrl = "https://cdn.jsdelivr.net/gh/lukes/ISO-3166-Countries-with-Regional-Codes@master/all/all.json";

            Promise.all([
                d3.json(topologyUrl),
                d3.json(metadataUrl)
            ]).then(([topology, metaJson]) => {
                
                metaJson.forEach(item => {
                    const numericCode = parseInt(item["country-code"], 10);
                    metadata[numericCode] = {
                        name: item.name,
                        region: item.region,
                        subregion: item["sub-region"]
                    };
                });

                countriesData = topojson.feature(topology, topology.objects.countries).features;
                renderMap();
                loadingDiv.style.display = 'none';

            }).catch(err => {
                console.error(err);
                loadingDiv.innerHTML = `
                    <span class="text-red-600 mb-2">Error loading map data (Rate Limit).</span>
                    <button class="retry-btn" onclick="loadData()">Retry</button>
                `;
            });
        }

        // Initialize loading
        loadData();

        // --- UI Logic ---

        function setMode(mode) {
            currentMode = mode;
            
            // Update Button Styling
            if (mode === 'green') {
                btnGreen.className = "px-4 py-2 bg-green-200 border-2 border-green-600 text-green-900 rounded font-bold shadow-sm transition";
                btnRed.className = "px-4 py-2 bg-red-100 border-2 border-transparent hover:bg-red-200 text-red-900 rounded transition";
            } else {
                btnGreen.className = "px-4 py-2 bg-green-100 border-2 border-transparent hover:bg-green-200 text-green-900 rounded transition";
                btnRed.className = "px-4 py-2 bg-red-200 border-2 border-red-600 text-red-900 rounded font-bold shadow-sm transition";
            }
        }

        // --- Rendering Logic ---

        function renderMap() {
            // Clear existing paths if any (for re-render safety)
            g.selectAll("path").remove();

            g.selectAll("path")
                .data(countriesData)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", "country")
                .attr("id", d => `country-${d.id}`)
                .on("mouseover", function(event, d) {
                    const info = metadata[parseInt(d.id)];
                    const name = info ? info.name : "Unknown Country";
                    
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(name)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition().duration(500).style("opacity", 0);
                })
                .on("click", function(event, d) {
                    const el = d3.select(this);
                    
                    const isCurrentColor = el.classed(currentMode);

                    // Reset classes first
                    if (isCurrentColor) {
                        el.classed("green", false);
                        el.classed("red", false);
                    } else {
                        // Remove others, add current
                        el.classed("green", false);
                        el.classed("red", false);
                        el.classed(currentMode, true);
                    }
                    
                    updateCount();
                });
        }

        function selectContinent(targetRegion) {
            if (countriesData.length === 0) return;

            const paths = g.selectAll("path");
            let allAlreadyCurrentColor = true;
            
            // Check state of continent relative to CURRENT MODE
            paths.each(function(d) {
                const id = parseInt(d.id);
                const info = metadata[id];
                if (info && info.region === targetRegion) {
                    if (!d3.select(this).classed(currentMode)) {
                        allAlreadyCurrentColor = false;
                    }
                }
            });

            paths.classed("green", function(d) {
                return updateClass(this, d, targetRegion, "green", allAlreadyCurrentColor);
            });
            
            paths.classed("red", function(d) {
                return updateClass(this, d, targetRegion, "red", allAlreadyCurrentColor);
            });

            updateCount();
        }

        // Helper to update classes safely for continents
        function updateClass(element, d, targetRegion, classColor, allSelected) {
            const id = parseInt(d.id);
            const info = metadata[id];
            const el = d3.select(element);
            
            // If this country is in the target region
            if (info && info.region === targetRegion) {
                // If we are applying THIS color mode
                if (currentMode === classColor) {
                    // Toggle: if all were selected, deselect. Else select.
                    return !allSelected;
                } else {
                    // If this is the OTHER color mode, we must remove it if we are selecting
                    // If we are deselecting (allSelected is true), we technically just leave it?
                    // Let's assume selecting a continent overwrites previous colors.
                    return false; 
                }
            }
            // Preserve existing state for non-target countries
            return el.classed(classColor);
        }

        function resetMap() {
            g.selectAll("path")
                .classed("green", false)
                .classed("red", false);
            updateCount();
        }

        function updateCount() {
            const greenCount = g.selectAll(".country.green").size();
            const redCount = g.selectAll(".country.red").size();
            
            countGreenSpan.innerText = greenCount;
            countRedSpan.innerText = redCount;
        }

    </script>
</body>
</html>