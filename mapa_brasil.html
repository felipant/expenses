<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mapa do Brasil — Cidades Específicas</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        html, body, #map { 
            height: 100%; 
            margin: 0; 
            padding: 0;
            background-color: #f1f4ee; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #map { 
            background: #f1f4ee; 
            outline: none;
        }

        /* Loading Overlay */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
            color: #333;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #ddd;
            border-top-color: #55634c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Estilo dos Rótulos */
        .city-label {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 4px;
            font-size: 15px;
            font-weight: 700;
            color: #333;
            text-align: center;
            line-height: 1.2;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            pointer-events: none; /* Permite clicar através do rótulo */
            transition: all 0.2s ease;
            padding: 2px 6px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Rótulo selecionado */
        .city-label.selected-label {
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            background: #55634c;
            transform: scale(1.1);
            z-index: 1000;
            border-color: #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Painel de Legenda */
        .info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
        }

        .info-panel h4 { margin: 0 0 8px 0; color: #333; font-size: 16px; }
        .info-panel p { margin: 0; font-size: 13px; color: #666; }
        .counter-badge {
            background: #55634c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="loading">
        <div class="spinner"></div>
        <span id="loading-text">Carregando mapa...</span>
    </div>

    <div class="info-panel">
        <h4>Cidades em Destaque</h4>
        <p>Clique nos estados para selecionar.</p>
        <div style="margin-top:10px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; font-weight: 600;">Selecionados:</span>
            <span id="counter" class="counter-badge">0</span>
        </div>
    </div>

    <!-- Bibliotecas JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- CONFIGURAÇÃO ---
        const LOCALE_STORAGE_KEY = 'br_states_geojson_v5'; 
        const CACHE_TTL_MS = 1000 * 60 * 60 * 24 * 7; // 7 dias
        
        // Fontes de GeoJSON
        const GEOJSON_SOURCES = [
            'https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson',
            'https://raw.githubusercontent.com/giuliano-macedo/geodata-br-states/master/geojson/br_states.json',
            'https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/master/estados.geojson'
        ];

        // --- DADOS DAS CIDADES ESPECÍFICAS ---
        // Mapeamento por Sigla do Estado -> Dados da Cidade
        const targetCities = {
            //'CE': { name: 'Fortaleza', lat: -3.71722, lng: -38.5434 },
            'SC': { name: 'Santa Catarina', lat: -27.5959, lng: -48.5480 },
            'MG': { name: 'Montes Claros', lat: -16.7181, lng: -43.8641 },
            'PR': { name: 'Colombo', lat: -25.2917, lng: -49.2242 },
            'RS': { name: 'Pelotas', lat: -31.7654, lng: -52.3376 }
        };

        // --- INICIALIZAÇÃO DO MAPA ---
        const map = L.map('map', {
            zoomControl: true,
            zoomSnap: 0.1,
            attributionControl: false
        }).setView([-14.2350, -51.9253], 4.2);

        L.control.attribution({position: 'bottomleft'}).addAttribution('&copy; OpenStreetMap').addTo(map);

        // --- VARIÁVEIS DE ESTADO ---
        const selectedStates = new Set(); 
        let geojsonLayer; 
        const labelsMap = {}; // Armazena { label: Marker, dot: CircleMarker }
        const loadingEl = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');

        // --- SISTEMA DE CACHE & FETCH ---
        async function fetchWithFallback(sources) {
            let lastError;
            for (const url of sources) {
                try {
                    loadingText.textContent = "Baixando dados...";
                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    return await resp.json();
                } catch (err) {
                    console.warn(`Falha na fonte ${url}:`, err);
                    lastError = err;
                }
            }
            throw lastError || new Error("Todas as fontes falharam. Verifique sua conexão.");
        }

        function loadGeoJSON() {
            try {
                const cached = localStorage.getItem(LOCALE_STORAGE_KEY);
                if (cached) {
                    const { timestamp, data } = JSON.parse(cached);
                    if (Date.now() - timestamp < CACHE_TTL_MS) {
                        console.log("Usando cache local.");
                        renderMap(data);
                        return;
                    }
                }
            } catch (e) { console.warn("Erro ao ler cache", e); }

            fetchWithFallback(GEOJSON_SOURCES)
                .then(data => {
                    try {
                        localStorage.setItem(LOCALE_STORAGE_KEY, JSON.stringify({
                            timestamp: Date.now(),
                            data: data
                        }));
                    } catch (e) { console.warn("Cache indisponível"); }
                    renderMap(data);
                })
                .catch(err => {
                    loadingEl.style.display = 'flex';
                    loadingText.innerHTML = "Erro ao carregar mapa.<br><span style='font-size:0.8em'>Tente recarregar.</span>";
                    loadingText.style.color = "#d32f2f";
                });
        }

        // --- HELPER FUNCTIONS ---
        function getStateId(feature) {
            if (!feature || !feature.properties) return "UNKNOWN";
            const p = feature.properties;
            return p.sigla || p.SIGLA || p.abbreviation || p.name || p.nome || "UNKNOWN_" + Math.random();
        }

        // --- RENDERIZAÇÃO ---
        function style(feature) {
            const id = getStateId(feature);
            const isSelected = selectedStates.has(id);
            return {
                fillColor: isSelected ? '#55634c' : 'transparent',
                weight: isSelected ? 1.5 : 1.0,
                opacity: 1,
                color: '#333', 
                fillOpacity: isSelected ? 1 : 0.0,
            };
        }

        function highlightFeature(e) {
            const layer = e.target;
            const feature = layer.feature;
            if (!feature) return;

            const id = getStateId(feature);

            if (selectedStates.has(id)) {
                // DESMARCAR
                selectedStates.delete(id);
                
                if (labelsMap[id]) {
                    // Restaura estilo padrão do texto
                    labelsMap[id].label.getElement().classList.remove('selected-label');
                    // Restaura cor do ponto para preto
                    labelsMap[id].dot.setStyle({ fillColor: '#333', color: '#fff' });
                }
                
                layer.setStyle({
                    fillColor: 'transparent',
                    fillOpacity: 0.0,
                    weight: 1.0,
                    color: '#333'
                });
            } else {
                // SELECIONAR
                selectedStates.add(id);
                
                if (labelsMap[id]) {
                    // Destaca texto
                    labelsMap[id].label.getElement().classList.add('selected-label');
                    // Muda ponto para branco
                    labelsMap[id].dot.setStyle({ fillColor: '#fff', color: '#333' });
                }
                
                layer.setStyle({
                    fillColor: '#55634c',
                    fillOpacity: 1,
                    weight: 1.5,
                    color: '#1a1a1a'
                });
                layer.bringToFront();
            }

            document.getElementById('counter').innerText = selectedStates.size;
        }

        function onEachFeature(feature, layer) {
            const id = getStateId(feature);

            layer.on({
                click: highlightFeature,
                mouseover: (e) => {
                    if (!selectedStates.has(id)) {
                        e.target.setStyle({ weight: 2.0, color: '#000' });
                    }
                },
                mouseout: (e) => {
                    if (!selectedStates.has(id)) {
                        geojsonLayer.resetStyle(e.target);
                    } else {
                        e.target.setStyle({
                            fillColor: '#55634c',
                            fillOpacity: 1,
                            weight: 1.5,
                            color: '#1a1a1a'
                        });
                    }
                }
            });

            // Verificar se este estado possui uma cidade alvo
            if (targetCities[id]) {
                const city = targetCities[id];
                const latLng = [city.lat, city.lng];

                // 1. Cria o Ponto (Dot)
                const dotMarker = L.circleMarker(latLng, {
                    radius: 4,          // Tamanho do ponto
                    fillColor: '#333',  // Cor interna inicial (preto)
                    color: '#fff',      // Borda branca para contraste
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 1,
                    interactive: false  // Não interfere no clique do estado
                }).addTo(map);

                // 2. Cria o Rótulo (Texto)
                const labelIcon = L.divIcon({
                    className: 'city-label',
                    html: `<div>${city.name}</div>`,
                    iconSize: null,
                    // Offset para o texto ficar levemente acima do ponto
                    iconAnchor: [30, 15]
                });

                const textMarker = L.marker(latLng, { 
                    icon: labelIcon, 
                    interactive: false 
                }).addTo(map);

                // Salva referência de AMBOS para interação
                labelsMap[id] = { 
                    label: textMarker, 
                    dot: dotMarker 
                };
            }
        }

        function renderMap(data) {
            loadingEl.style.display = 'none';
            
            if (geojsonLayer) map.removeLayer(geojsonLayer);

            geojsonLayer = L.geoJSON(data, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);

            try {
                map.fitBounds(geojsonLayer.getBounds(), { padding: [30, 30] });
            } catch(e) { console.log("Erro ao ajustar zoom", e); }
        }

        loadGeoJSON();

    </script>
</body>
</html>