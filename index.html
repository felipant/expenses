<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Despesa</title>
    <link rel="icon" type="image/png" href="dol.png">
    <style>
         @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap'); 
  
         /* --- LIGHT MODE (Default) --- */
         body { 
             background-color: #f8f8f8; 
             color: #222; 
             font-family: 'Inter', sans-serif; 
             display: flex; 
             justify-content: center; 
             align-items: center; 
             height: 100vh; 
             margin: 0; 
         } 
  
         .form-container { 
             background: #ffffff; 
             padding: 30px; 
             border-radius: 8px; 
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
             width: 400px; 
             text-align: center; 
             border: 1px solid #ddd; 
         } 
  
         h2 { 
             color: #000; 
             font-weight: 700; 
             margin-bottom: 20px; 
             font-size: 20px; 
         } 
  
         label { 
             display:flex; 
             margin: 10px 0 5px; 
             font-size: 14px; 
             align-items: center; 
             font-weight: 500; 
             color: #333; 
         } 
  
         input, select { 
             width: 100%; 
             padding: 10px; 
             background: #fff; 
             border: 1px solid #bbb; 
             color: #222; 
             font-size: 16px; 
             border-radius: 5px; 
             outline: none; 
             transition: 0.2s ease-in-out; 
         } 
  
         input:focus, select:focus { 
             border-color: #000; 
             box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); 
         } 
  
         .btn { 
             margin-top: 20px; 
             background: #000; 
             color: white; 
             padding: 12px; 
             border: none; 
             cursor: pointer; 
             font-size: 16px; 
             width: 100%; 
             border-radius: 5px; 
             font-weight: bold; 
             transition: 0.2s ease-in-out; 
         } 

         .btn:hover { 
             background: #333; 
         } 

         /* --- NOVOS ESTILOS PARA O RESET --- */
         .btn-row {
             display: flex;
             gap: 10px; /* Espaço entre os botões */
             margin-top: 20px;
         }

         .btn-row .btn {
             margin-top: 0; /* Remove margem superior pois o pai já controla */
         }

         .btn-red {
             background-color: #d32f2f; /* Vermelho */
         }

         .btn-red:hover {
             background-color: #b71c1c; /* Vermelho mais escuro */
         }
         /* ---------------------------------- */
  
         .main-wrapper {
            display: flex;
            gap: 30px; 
            align-items: center;
        }

        .sum-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            text-align: center;
            border: 1px solid #ddd;
            display: none; 
        }

        .sum-container h3 {
            margin-top: 0;
            font-size: 16px;
            color: #000;
        }

        .input-row {
            display: flex;
            margin-bottom: 10px;
        }

        .input-row input {
            flex-grow: 1;
            margin-right: 5px;
            width: auto;
        }

        .total-display {
            margin-top: 15px;
            padding: 10px;
            background: #f1f1f1;
            border-radius: 5px;
            font-weight: bold;
            font-size: 18px;
            color: #000;
        }

        input[type="checkbox"] { 
             width: 20px; 
             height: 20px; 
         } 

        /* Dark Mode support */
        @media (prefers-color-scheme: dark) {
            :root { color-scheme: dark; }
            body {
                 background-color: #121212; 
                 color: #e0e0e0; 
            }
            .form-container, .sum-container {
                 background: #1e1e1e; 
                 box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); 
                 border: 1px solid #333;
            }
            .sum-container h3, h2 {
                color: #ffffff;
            }
            .total-display {
                background: #2b2b2b;
                color: #e0e0e0;
            }
            label { color: #cccccc; }
            input, select {
                 background: #2b2b2b; 
                 border: 1px solid #444;
                 color: #e0e0e0;
            }
            input:focus, select:focus {
                 border-color: #888;
                 box-shadow: 0 0 5px rgba(255, 255, 255, 0.2); 
            }
            .btn {
                 background: #bb86fc; 
                 color: #121212;
            }
            .btn:hover { background: #9a67ea; }
            
            /* Ajuste do botão vermelho no modo escuro */
            .btn-red { background-color: #cf6679; color: #000; }
            .btn-red:hover { background-color: #b00020; color: #fff; }
        }
  
    </style>
</head>
<body>
    <div class="main-wrapper">

        <div class="form-container">
            <h2>Adicionar Despesa</h2>
            <form id="dataForm" method="post">
                <label for="dia">Data</label>
                <input type="date" id="dia" name="dia" value="">

                <div class="input-group">
                    <label for="amount">Valor (R$):</label>
                    <input type="text" id="amount" name="amount" inputmode="numeric" placeholder="0.00">
                </div>

                <label for="comentario">Comentário/Item:</label>
                <input id="comentario" type="text" list="itemSuggestions">
                
                <datalist id="itemSuggestions">
                </datalist>

                <div class="form-group">
                    <label for="categoria">Categoria:</label>
                    <select id="categoria" name="categoria" onchange="atualizarSubcategorias()">
                        <option value="">Selecione uma categoria</option>
                    </select>

                    <label for="subcategoria">Subcategoria:</label>
                    <select id="subcategoria" name="subcategoria">
                        <option value="">Selecione uma subcategoria</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="parcelas">Parcelas:</label>
                    <select id="parcelas" name="parcelas">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipo">Tipo de gasto:</label>
                    <select id="tipo" name="tipo">
                        <option value="Variável">Variável</option>
                        <option value="Fixo">Fixo</option>
                    </select>
                </div>

                <label for="myCheckbox">
                    <input type="checkbox" name="subscribe" value="yes"  id="myCheckbox">
                    Receber e-mail
                </label>

                <button type="submit" class="btn" id="addic">Adicionar</button>
                <p></p>
            </form>
            <div id="status"></div>

            <script>
                async function carregarDados() {
                    try {
                        const response = await fetch('./data/categorias.json');
                        const data = await response.json();
                        
                        const categoriaSelect = document.getElementById("categoria");
                        for (const categoria in data.categorias) {
                            const option = document.createElement("option");
                            option.value = categoria;
                            option.textContent = categoria;
                            categoriaSelect.appendChild(option);
                        }
                        
                        window.subcategorias = data.categorias;
                    } catch (error) {
                        console.error("Erro ao carregar o arquivo JSON", error);
                    }
                }
                
                function atualizarSubcategorias() {
                    const categoriaSelecionada = document.getElementById("categoria").value;
                    const subcategoriaSelect = document.getElementById("subcategoria");
                    
                    subcategoriaSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
                    
                    if (categoriaSelecionada && window.subcategorias[categoriaSelecionada]) {
                        window.subcategorias[categoriaSelecionada].forEach(sub => {
                            const option = document.createElement("option");
                            option.value = sub;
                            option.textContent = sub;
                            subcategoriaSelect.appendChild(option);
                        });
                    }
                }
                
                carregarDados();
            </script>

            <script>
                let itemMapping = {};

                async function carregarItens() {
                    try {
                        const response = await fetch('./data/itens.json'); 
                        const data = await response.json();
                        itemMapping = data.itens; 

                        const datalist = document.getElementById("itemSuggestions");
                        
                        for (const item in itemMapping) {
                            const option = document.createElement("option");
                            option.value = item;
                            datalist.appendChild(option);
                        }
                    } catch (error) {
                        console.error("Erro ao carregar o arquivo itens.json", error);
                    }
                }
                
                function categorizarAutomaticamente() {
                    const comentarioInput = document.getElementById("comentario");
                    const categoriaSelect = document.getElementById("categoria");
                    const subcategoriaSelect = document.getElementById("subcategoria");
                    
                    const typedItem = comentarioInput.value.trim();
                    
                    if (itemMapping.hasOwnProperty(typedItem)) {
                        const mapping = itemMapping[typedItem];
                        categoriaSelect.value = mapping.categoria;
                        atualizarSubcategorias(); 
                        subcategoriaSelect.value = mapping.subcategoria;
                    } else {
                        categoriaSelect.value = "";
                        atualizarSubcategorias(); 
                    }
                }

                document.addEventListener('DOMContentLoaded', () => {
                    carregarItens(); 
                    document.getElementById("comentario").addEventListener("input", categorizarAutomaticamente);
                });
            </script>

            <script>
                const amountInput = document.getElementById('amount');

                amountInput.addEventListener('input', function(e) {
                    let value = this.value.replace(/[^\d]/g, '');
                    while (value.length < 3) {
                        value = '0' + value;
                    }
                    const dollars = value.slice(0, -2);
                    const cents = value.slice(-2);
                    const formattedDollars = Number(dollars).toLocaleString('en-US');
                    this.value = formattedDollars + '.' + cents;
                });

                amountInput.addEventListener('focus', function(e) {
                    const value = this.value.replace(/[^\d.]/g, '');
                    this.value = value;
                });

                amountInput.addEventListener('blur', function(e) {
                    if (this.value === '') {
                        this.value = '';
                        return;
                    }
                    let value = this.value.replace(/[^\d.]/g, '');
                    const parts = value.split('.');
                    let cents = parseInt((parts[0] || '0') + (parts[1] || '00').padEnd(2, '0'));
                    const dollars = Math.floor(cents / 100).toLocaleString('en-US');
                    const remainingCents = (cents % 100).toString().padStart(2, '0');
                    this.value = dollars + '.' + remainingCents;
                });
            </script>

            <script>
                document.getElementById("dataForm").addEventListener("submit", function(event) {
                    event.preventDefault();
                    document.getElementById("addic").innerText="Enviando...";
                    let cbox = document.getElementById("myCheckbox");
                    let mail = "no"; 
                    if (cbox.checked) {     
                        mail = "yes"; 
                    }

                    let formData = {
                        data_compra: document.getElementById("dia").value,
                        valor: document.getElementById("amount").value,
                        categoria: document.getElementById("categoria").value,
                        subcategoria: document.getElementById("subcategoria").value,
                        parcelas: document.getElementById("parcelas").value,
                        tipo: document.getElementById("tipo").value,
                        comentario: document.getElementById("comentario").value,
                        mail: mail,
                    };

                    fetch("https://script.google.com/macros/s/AKfycbyb8xHVHJDHsBFqgWLjrUZSJ7t0TTDYYHWYhszDk7H8lVPlai55VbqGAer2XSgOp5D_hw/exec", {
                        method: "POST",
                        mode: "no-cors",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(formData)
                    }).then(() => {
                        document.getElementById("status").innerText = "Dados enviados com sucesso!";
                        document.getElementById("dataForm").reset();
                        
                        // CORREÇÃO: Reseta a calculadora usando a nova função global
                        if (typeof window.resetCalculator === 'function') {
                            window.resetCalculator();
                        }
                        
                        document.getElementById("addic").innerText="Adicionar";
                        setTimeout(() => {
                            document.getElementById("status").innerText = "";
                        }, 1000);
                        atualizarDia();
                    }).catch(error => console.error("Error:", error));
                });

                function atualizarDia() {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById("dia").value = today;
                }
                atualizarDia();
            </script>

        </div>

        <div class="sum-container" id="sumToolBox">
            <h3>Calculadora de Itens</h3>
            <div id="inputList">
            </div>
            
            <div class="btn-row">
                <button type="button" id="addButton" class="btn" style="flex: 1;">+</button>
                <button type="button" id="resetButton" class="btn btn-red" style="flex: 1;">Limpar</button>
            </div>

            <div class="total-display">
                Total: <span id="currentSumDisplay">R$ 0,00</span>
            </div>


            <script>
                function isDesktop() {
                    const userAgent = navigator.userAgent;
                    return (
                        (userAgent.includes("Win") || userAgent.includes("Macintosh")) && 
                        !userAgent.includes("Mobi") && 
                        !userAgent.includes("Android")
                    );
                }

                const inputList = document.getElementById('inputList');
                const addButton = document.getElementById('addButton');
                const currentSumDisplay = document.getElementById('currentSumDisplay');
                const mainAmountInput = document.getElementById('amount'); 
                const sumToolBox = document.getElementById('sumToolBox');
                
                function formatCurrency(value) {
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                }
                
                function applyCurrencyFormatting(e) {
                    let input = e.target;
                    let value = input.value.replace(/[^\d]/g, ''); 
                    while (value.length < 3) { value = '0' + value; }
                    const dollars = value.slice(0, -2);
                    const cents = value.slice(-2);
                    const formattedDollars = Number(dollars).toLocaleString('pt-BR'); 
                    input.value = formattedDollars + ',' + cents;
                }

                function normalizeCurrencyOnBlur(e) {
                    let input = e.target;
                    if (input.value === '') {
                        input.value = '';
                        updateSum();
                        return;
                    }
                    let value = input.value.replace(/\./g, '').replace(',', '.'); 
                    const numericValue = parseFloat(value) || 0;
                    input.value = numericValue.toLocaleString('pt-BR', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
                    updateSum();
                }
                
                function updateSum() {
                    let totalCents = 0;
                    const rows = inputList.querySelectorAll('.input-row');
                    
                    rows.forEach(row => {
                        const priceInput = row.querySelector('.item-price');
                        const quantityInput = row.querySelector('.item-quantity');
                        
                        let priceValue = priceInput.value.replace(/\./g, '').replace(',', '.'); 
                        const price = parseFloat(priceValue) || 0;
                        const quantity = parseInt(quantityInput.value) || 1; 
                        const subtotal = price * quantity;
                        totalCents += Math.round(subtotal * 100); 
                    });
                    
                    const total = totalCents / 100;
                    currentSumDisplay.textContent = formatCurrency(total);
                    mainAmountInput.value = total.toFixed(2); 
                    mainAmountInput.dispatchEvent(new Event('blur')); 
                }
                
                function createNewInput() {
                    const inputRow = document.createElement('div');
                    inputRow.className = 'input-row';
                    
                    const priceInput = document.createElement('input');
                    priceInput.type = 'text';
                    priceInput.className = 'item-price';
                    priceInput.inputmode = 'numeric';
                    priceInput.placeholder = '0,00';
                    priceInput.value = '0,00'; 
                    priceInput.addEventListener('input', applyCurrencyFormatting);
                    priceInput.addEventListener('blur', normalizeCurrencyOnBlur);
                    
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.className = 'item-quantity';
                    quantityInput.min = '1';
                    quantityInput.value = '1'; 
                    quantityInput.style.width = '60px'; 
                    quantityInput.style.textAlign = 'center';
                    quantityInput.addEventListener('input', updateSum);
                    
                    inputRow.appendChild(priceInput);
                    inputRow.appendChild(quantityInput);
                    inputList.appendChild(inputRow);
                    
                    priceInput.focus();
                }

                document.addEventListener('DOMContentLoaded', () => {
                    if (isDesktop()) {
                        sumToolBox.style.display = 'flex'; 
                        sumToolBox.style.flexDirection = 'column';
                        
                        createNewInput(); 
                        
                        addButton.addEventListener('click', () => {
                            createNewInput();
                        });

                        // --- LÓGICA DO RESET ---
                        const resetButton = document.getElementById('resetButton');

                        // Função Global para limpar (para usar aqui e no envio do form)
                        window.resetCalculator = function() {
                            inputList.innerHTML = ''; // Limpa as linhas
                            createNewInput(); // Adiciona uma nova linha vazia
                            updateSum(); // Zera o total
                        };

                        resetButton.addEventListener('click', window.resetCalculator);
                        // ------------------------
                        
                        updateSum();
                    }
                });
            </script>
        </div>
    </div>

</body>
</html>